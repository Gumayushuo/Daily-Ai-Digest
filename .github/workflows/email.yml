name: Daily Paper Digest

on:
  schedule:
    # 每天早上 8 点运行 (北京时间)
    - cron: '0 0 * * *'  # UTC 时间比北京时间慢 8 小时，所以 UTC 0 点 = 北京时间 8 点
  workflow_dispatch: # 手动触发也可以

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install feedparser markdownify requests pandas openai

      - name: Run RSS Fetcher
        run: |
          python scripts/rss_reader.py

      - name: Generate Digest using ChatGPT
        run: |
          python scripts/generate_digest.py
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - name: Send Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: www.email.cugb.edu.cn
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "Daily AI Paper Digest - $(date +'%Y-%m-%d')"
          to: "1001210725@email.cugb.edu.cn"
          from: ${{ secrets.EMAIL_USER }}
          body_file: "output/daily.md"
